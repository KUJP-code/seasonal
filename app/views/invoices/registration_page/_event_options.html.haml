-# locals: (child:, event_options:, confirmed_opt_regs:,
  registrations:, siblings:)

:ruby
  siblings_registered_for_event = if event_options.first
    event_id = event_options.first.optionable_id
    siblings.any? { |sibling| sibling.time_slots.where(event_id: event_id).exists? }
  else
    false
  end


- event_options.each do |opt|
  - if confirmed_opt_regs.any? { |reg| reg.registerable_id == opt.id }
  - else
    :ruby
      registered = registrations.any? do |reg|
        reg.child_id == child.id && reg.registerable_id == opt.id
      end
      sibling_has_photo = opt.optionable.respond_to?(:pricing_rules_2026?) &&
        opt.optionable.pricing_rules_2026? &&
        siblings.any? { |sibling| sibling.options.exists?(id: opt.id) }
      show_sibling_warning = opt.event? &&
        opt.optionable.respond_to?(:pricing_rules_2026?) &&
        opt.optionable.pricing_rules_2026? &&
        siblings_registered_for_event
      default_opt = opt.optionable.party? || sibling_has_photo
    %div{ class: 'add_ref ' \
                 'form-check form-switch p-0',
          data: { controller: 'register',
                  'register-id-value': opt.id,
                  'register-type-value': 'Option',
                  'register-child-value': @child.id,
                  'register-cost-value': opt.cost,
                  'register-default-value': (default_opt ? 'true' : 'false'),
                  'register-sibling-warning-value': (show_sibling_warning ? 'true' : 'false'),
                  'register-sibling-warning-message-value':
                    '兄弟姉妹のお申込内容にもフォトサービスが反映されます。続行しますか？'
                  } }

      %label{ class: 'photoservice-container',
              'data-register-target': 'name', for: "eopt#{opt.id}" }
        = picture_tag ['photo_service.png', 'photo_service_mobile.png'],
                      class: 'photoservice-picture',
                      image: { class: 'photoservice-image' }

        .photoservice-label
          .text-white.fw-bold= number_to_currency(opt.cost, locale: :ja)
          = check_box_tag "eopt#{opt.id}",
                          "eopt#{opt.id}",
                          (true if registered),
                          class: 'form-check-input m-0',
                          data: { action: 'register#toggle',
                                  'register-target': 'button' },
                          role: 'switch'
      - if opt.optionable.respond_to?(:seasonal?) && opt.optionable.seasonal?
        %p.text-white.text-center.mb-0.mt-1.fw-semibold{ style: 'font-size: 0.75rem;' }
          ※ごきょうだいでフォトサービスをご利用の場合は、全員分のお申込みが必要です。お一人でもお申込みいただくと、同じシーズナルスクールに参加するごきょうだいも自動的にフォトサービスが追加されます。
      - if opt.optionable.party?
        %p.text-white.small.text-center.mt-1.mb-0{ style: "font-size: 0.75rem;" }
          ※フォトサービスを利用されない方はチェックを外してください
